sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Layout","sap/ui/comp/smartform/ColumnLayout","sap/ui/comp/smartform/Group","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,o,s,i,r,a,n,l,c){"use strict";return e.extend("fi.pms.solution.ZFI_PMS_SOL_PREVIEW.controller.View1",{onInit:function(){var e=sap.ui.core.Component.getOwnerIdFor(this.getView());var t=sap.ui.component(e);this._onObjectMatched(t.getComponentData().startupParameters.processId[0],t.getComponentData().startupParameters.projectId[0],t.getComponentData().startupParameters.projectDesc[0],t.getComponentData().startupParameters.processDesc[0],t.getComponentData().startupParameters.Preview[0])},_onObjectMatched:function(e,t,o,s,i){if(i==="true"){this.preview=true}else{this.preview=false}this.SmartFormCollection=[];o=decodeURIComponent(o);s=decodeURIComponent(s);var r=new a;if(this.preview){r.setProperty("/UserControlVisibility",false)}else{r.setProperty("/UserControlVisibility",true)}this.getView().setModel(r,"VisibilityModel");this.getView().getModel("viewData").setProperty("/ProjTitle",o);this.getView().getModel("viewData").setProperty("/processTitle",s);this.getView().getModel("viewData").setProperty("/ProjId",t);this.getView().getModel("viewData").setProperty("/processId",e);this.getView().setBusy(true);this.getView().getModel("viewData").setProperty("/ProjTitle",o);this.getView().getModel("viewData").setProperty("/processTitle",s);var n=[];n.push(new sap.ui.model.Filter("Projid","EQ",t));n.push(new sap.ui.model.Filter("Process","EQ",e));var l={filters:n,success:function(e){this.getView().setBusy(false);this.getView().getModel("dynamicFormModel").setData(e);this.oVirtualEntryContext=this.getView().getModel().createEntry("DynEntItemSet");this._createSmartFormElements()}.bind(this),error:function(){this.getView().setBusy(false)}};this.getView().getModel("staticModel").read("/ProcessMasterSet",l)},_createSmartFormElements:function(){this.getView().setBusy(true);var e=this.getView().getModel("dynamicFormModel").getData().results;var t=this.getView().byId("smartFormContainer");t.removeAllSections();var o=this._createSectionControl(e[0].SectionType);if(e[0].SectionType.toUpperCase()==="FORM"){var s=new r({})}else if(e[0].SectionType.toUpperCase()==="TABLE"){var i=new sap.m.ColumnListItem({})}var a=parseInt(e[0].SectionSeqNum);for(var n=0;n<e.length;n++){if(e[n].Fieldname!=="MANDT"&&e[n].Fieldname!=="PROJECT_ID"&&e[n].Fieldname!=="PROCESS_ID"){if(a!==parseInt(e[n].SectionSeqNum)){a=parseInt(e[n].SectionSeqNum);if(e[n-1].SectionType.toUpperCase()==="FORM"){o.addGroup(s);this._createObjectPageSection(o,e[n-1].SectionName)}else if(e[n-1].SectionType.toUpperCase()==="TABLE"){o.addItem(i);this._createObjectPageSection(o,e[n-1].SectionName)}o=this._createSectionControl(e[n].SectionType);if(e[n].SectionType.toUpperCase()==="FORM"){var s=new r({})}else if(e[n].SectionType.toUpperCase()==="TABLE"){var i=new sap.m.ColumnListItem({})}}if(e[n].SectionType.toUpperCase()==="FORM"){var l=new sap.ui.comp.smartfield.SmartField({value:"{"+e[n].Fieldname+"}"});var c=new sap.ui.comp.smartform.GroupElement;c.addElement(l);s.addGroupElement(c)}else if(e[n].SectionType.toUpperCase()==="TABLE"){var p=new sap.m.Column({header:new sap.m.Text({text:e[n].LabelName})});i.addCell(new sap.ui.comp.smartfield.SmartField({value:"{"+e[n].Fieldname+"}"}));o.addColumn(p)}}}if(e[e.length-1].SectionType.toUpperCase()==="FORM"){o.addGroup(s);this._createObjectPageSection(o,e[e.length-1].SectionName)}else if(e[e.length-1].SectionType.toUpperCase()==="TABLE"){o.addItem(i);this._createObjectPageSection(o,e[e.length-1].SectionName)}this.getView().setBusy(false)},_createSectionControl:function(e){var t;if(e.toUpperCase()==="FORM"){t=new sap.ui.comp.smartform.SmartForm({editTogglable:false,entityType:"DynEntItem",editable:true,layout:new sap.ui.comp.smartform.ColumnLayout({columnsXL:4,columnsL:3,columnsM:2,labelCellsLarge:4,emptyCellsLarge:0}),useHorizontalLayout:false});this.SmartFormCollection.push(t);if(this.preview){t.addStyleClass("pointerClass")}t.setBindingContext(this.oVirtualEntryContext);return t}else if(e.toUpperCase()==="TABLE"){t=new sap.m.Table({inset:false});if(this.preview){t.addStyleClass("pointerClass")}t.setBindingContext(this.oVirtualEntryContext);return t}},_createObjectPageSection:function(e,t){var o=new sap.uxap.ObjectPageSection({title:t,subSections:new sap.uxap.ObjectPageSubSection({blocks:e})});this.getView().byId("smartFormContainer").addSection(o)},onUserFormSave:function(e){var t=false;for(var o=0;o<this.SmartFormCollection.length;o++){if(this.SmartFormCollection[o].check().length>0){t=true;l.show(this.getI18nText("fillMandatFields"));break}}if(!t){var s=this.getView().getModel().getProperty(this.oVirtualEntryContext.sPath);if(s.ACT_TS_COMP_DT<s.ACT_TS_ST_DT){l.show("Act TS Comp Date can not be less than Act TS Start Date");return}var i=this.getView().getModel("viewData");i.getProperty("/ProjId");i.getProperty("/processId");var r=i.getProperty("/ProjId");var a=i.getProperty("/processId");s.PROJECT_ID=r;s.PROCESS_ID=a;delete s.__metadata;var p={PROJECT_ID:r,PROCESS_ID:a,Nav_DynEntToDynEntItem:[s]};n.show();this.getOwnerComponent().getModel().create("/DynEntSet",p,{success:function(e,t){n.hide();c.success("Saved Successfully. Do you want to create another RICEF?",{actions:[c.Action.YES,c.Action.NO],onClose:function(e){if(e===c.Action.YES){location.reload()}else if(e===c.Action.NO){window.close()}}})},error:function(e){n.hide();var t=JSON.parse(e.responseText);var o=t.error.message.value;c.error(o)}})}},getI18nText:function(e){return this.getView().getModel("i18n").getResourceBundle().getText(e)},_callCrossApp:function(){var e={success:function(){this.getView().setBusy(false);var e=sap.ushell.Container.getService("CrossApplicationNavigation");var t=e&&e.hrefForExternal({target:{semanticObject:"ZFI_PMS_SEM",action:"display"}})||"";e.toExternal({target:{shellHash:t}})}.bind(this),error:function(){this.getView().setBusy(false)}.bind(this)};this.getView().getModel().read("/DynEntSet",e)},onBack:function(){var e,o;e=t.getInstance();o=e.getPreviousHash();if(o!==undefined){window.history.go(-1)}else{window.close()}}})});